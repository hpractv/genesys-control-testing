<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Genesys Cloud Widget Control</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="library.js" defer></script>
    <script src="data.json"></script>
    <script src="https://unpkg.com/lunr/lunr.js"></script>
    <script defer>
      let idx;
      var setUp = async () => {
        await gct.init();
        document.getElementById('conversationId').innerText =
          gct.params.conversationId ?? 'Unknown';
        document.getElementById('langTag').innerText = gct.params.langTag;

        idx = lunr(function () {
          this.ref('ID');
          this.field('FirstName');
          this.field('LastName');
          this.field('BirthDate');
          this.field('Age');

          Array.prototype.forEach.call(gct.population, person => {
            this.add(person);
          });
        });
      };

      const search = () => {
        const text = document.getElementById('search').value;
        const searchResults = document.getElementById('searchResults');
        searchResults.replaceChildren([]);
        const search = idx.search(`${text}*`);
        if (search.length > 0) {
          Array.prototype.forEach.call(search, r => {
            var resultRow = document.createElement('tr');
            var buildColumn = value => {
              var column = document.createElement('td');
              column.innerText = value;
              resultRow.appendChild(column);
            };
            buildColumn(r.ref);
            var person = gct.population.find(p => p.ID === Number(r.ref));
            buildColumn(person.FirstName);
            buildColumn(person.LastName);
            buildColumn(person.BirthDate);
            buildColumn(person.Age);
            searchResults.appendChild(resultRow);
          });
        }
      };
      window.onload = setUp;
    </script>
  </head>
  <body>
    <div class="widget-container">
      <div class="widget-header">Genesys Cloud Widget</div>
      <div class="widget-content">
        <div>
          Conversation Id:
          <div id="conversationId">Unknown</div>
        </div>
        <div>
          Lanaguage Tag:
          <div id="langTag">Unknown</div>
        </div>
        <hr />
        <div>
          Search <input id="search" type="text" size="25" />&nbsp;<button
            onclick="search()"
          >
            Search
          </button>

          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Birth Date</th>
                <th>Age</th>
              </tr>
            </thead>
            <tbody id="searchResults"></tbody>
          </table>
        </div>
        <div>
          First Name:
          <div id="firstName"></div>
        </div>
        <div>
          Middle Name:
          <div id="middleName"></div>
        </div>
        <div>
          Last Name:
          <div id="lastName"></div>
        </div>
        <div>
          Age
          <div id="age"></div>
        </div>
      </div>
    </div>
  </body>
</html>
